<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=yes"
        />
        <title>Project #1 - Luxo Lamp</title>
        <style>
            html,
            body {
                margin: 0;
                height: 100%;
            }
            #webgl {
                width: 100%;
                height: 100%;
                display: block;
            }
        </style>
    </head>
    <body>
        <canvas id="webgl"></canvas>
    </body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three/build/three.module.js",
                "orbitcontrols": "https://unpkg.com/three/examples/jsm/controls/OrbitControls.js",
                "datgui": "https://unpkg.com/dat.gui/build/dat.gui.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from "three";
        import { OrbitControls } from "orbitcontrols";
        import { GUI } from "datgui";

        function main() {
            const canvas = document.querySelector("#webgl");
            const renderer = new THREE.WebGLRenderer({ canvas });

            const scene = new THREE.Scene();
            scene.background = new THREE.Color("black");

            // for debuging
            const axesHelper = new THREE.AxesHelper(100);
            scene.add(axesHelper);

            // room
            const room = { width: 30, height: 20 };
            {
                const cubeGeo = new THREE.BoxGeometry(
                    room.width,
                    room.height,
                    room.width
                );
                const cubeMat = new THREE.MeshPhongMaterial({ color: "#8AC" });
                cubeMat.side = THREE.BackSide;
                const mesh = new THREE.Mesh(cubeGeo, cubeMat);
                mesh.position.set(0, room.height / 2, 0);
                scene.add(mesh);
            }

            // add some 3D models here -> Torus, Plane...
            const torus = {
                radius: 3,
                tube: 1,
                radialSegments: 16,
                tubularSegments: 100,
            };
            {
                const torusGeo = new THREE.TorusGeometry(
                    torus.radius,
                    torus.tube,
                    torus.radialSegments,
                    torus.tubularSegments
                );
                const torusMat = new THREE.MeshPhongMaterial({
                    color: "#FFFFFF",
                });
                const mesh = new THREE.Mesh(torusGeo, torusMat);
                mesh.position.set(-7, 8, -4);
                scene.add(mesh);
            }

            // define the luxo lamp

            // base
            const base = new THREE.Object3D();
            {
                scene.add(base);
            }

            // baseMesh
            const baseMesh = { width: 4, height: 1, color: "red" };
            {
                baseMesh.mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 1, 1),
                    new THREE.MeshPhongMaterial({ color: baseMesh.color })
                );
                base.add(baseMesh.mesh);
            }

            // baseDisc
            const baseDisc = new THREE.Object3D();
            {
                baseDisc.angle = 20;
                base.add(baseDisc);
            }

            // baseDiscMesh
            const baseDiscMesh = {
                radius: 1,
                height: 0.2,
                color: "orange",
                segs: 8,
            };
            {
                baseDiscMesh.mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        baseDiscMesh.radius,
                        baseDiscMesh.radius,
                        baseDiscMesh.height,
                        baseDiscMesh.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: baseDiscMesh.color })
                );
                baseDisc.add(baseDiscMesh.mesh);
            }

            const joint = {
                radius: 0.4,
                height: 1.0,
                color: "green",
                segs: 8,
            };

            const arm = {
                radius: 0.3,
                lowerHeight: 5,
                upperHeight: 4,
                color: "blue",
                segs: 8,
            };

            const lowerArm = new THREE.Object3D();
            {
                const angle = -30;
                lowerArm.rotation.x = Math.PI * (angle / 180);
                baseDisc.add(lowerArm);
            }

            {
                //lowest joint
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        joint.radius,
                        joint.radius,
                        joint.height,
                        joint.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: joint.color })
                );
                mesh.rotation.set(0, 0, Math.PI / 2);
                mesh.position.set(0, baseDiscMesh.height / 2, 0);
                lowerArm.add(mesh);
            }

            {
                //lower arm
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        arm.radius,
                        arm.radius,
                        arm.lowerHeight,
                        arm.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: arm.color })
                );
                mesh.position.set(0, arm.lowerHeight / 2, 0);
                lowerArm.add(mesh);
            }

            const upperArm = new THREE.Object3D();
            {
                const angle = 70;
                upperArm.position.set(0, arm.lowerHeight, 0);
                upperArm.rotation.x = Math.PI * (angle / 180);
                lowerArm.add(upperArm);
            }

            {
                //middle joint
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        joint.radius,
                        joint.radius,
                        joint.upperHeight,
                        joint.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: joint.color })
                );
                mesh.rotation.set(0, 0, Math.PI / 2);
                upperArm.add(mesh);
            }

            {
                //middle arm
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        arm.radius,
                        arm.radius,
                        arm.upperHeight,
                        arm.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: arm.color })
                );
                mesh.position.set(0, arm.upperHeight / 2, 0);
                upperArm.add(mesh);
            }

            const head = new THREE.Object3D();
            {
                const angle = 90;
                head.rotation.x = Math.PI * (angle / 180);
                head.position.set(0, arm.upperHeight, 0);
                upperArm.add(head);
            }

            {
                //middle joint
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        joint.radius,
                        joint.radius,
                        joint.height,
                        joint.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: joint.color })
                );
                mesh.rotation.set(0, 0, Math.PI / 2);
                mesh.position.set(0, baseDiscMesh.height / 2, 0);
                head.add(mesh);
            }

            // Add cylinder and light under the head joint
            const cover = {
                radiusTop: 2,
                radiusBottom: 0.4,
                height: 2.5,
                color: "gray",
                segs: 32,
            };
            {
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        cover.radiusTop,
                        cover.radiusBottom,
                        cover.height,
                        cover.segs
                    ),
                    new THREE.MeshPhongMaterial({ color: cover.color })
                );
                mesh.position.set(0, cover.height / 2, 0);
                head.add(mesh);
            }

            const bulb = {
                radius: 0.8,
                widthSegs: 32,
                heightSegs: 16,
                color: "white",
                lumen: 250,
            };
            {
                const mesh = new THREE.Mesh(
                    new THREE.SphereGeometry(
                        bulb.radius,
                        bulb.widthSegs,
                        bulb.heightSegs
                    ),
                    new THREE.MeshPhongMaterial({ color: bulb.color })
                );
                const light = new THREE.PointLight("white", 200);
                light.position.set(0, cover.height, 0);
                head.add(light);
                const helper = new THREE.PointLightHelper(light);
                scene.add(helper);
                mesh.position.set(0, cover.height, 0);
                head.add(mesh);
                head.add(light);
            }

            function updateLuxo() {
                base.position.y = baseMesh.height / 2;
                baseMesh.mesh.scale.set(
                    baseMesh.width,
                    baseMesh.height,
                    baseMesh.width
                );

                baseDisc.position.y = baseMesh.height / 2;
                baseDisc.rotation.y = THREE.MathUtils.degToRad(baseDisc.angle);
                baseDiscMesh.mesh.position.y = baseDiscMesh.height / 2;
            }

            updateLuxo();

            {
                const gui = new GUI();
                let posFolder;
                posFolder = gui.addFolder("base (red box)");
                posFolder
                    .add(base.position, "x", -room.width / 2, room.width / 2, 1)
                    .name("x")
                    .onChange(updateLuxo);
                posFolder
                    .add(base.position, "z", -room.width / 2, room.width / 2, 1)
                    .name("z")
                    .onChange(updateLuxo);
                posFolder
                    .add(baseMesh, "height", 0.1, 2, 0.1)
                    .name("height")
                    .onChange(updateLuxo);
                posFolder.open();

                let armFolder;
                armFolder = gui.addFolder("arm(blue) lengths");
                armFolder
                    .add(arm, "lowerHeight", 2, 7, 0.1)
                    .name("lower")
                    .onChange(updateLuxo);
                armFolder
                    .add(arm, "upperHeight", 2, 7, 0.1)
                    .name("upper")
                    .onChange(updateLuxo);
                armFolder.open();

                gui.addFolder("joint(green) angles");

                gui.add(baseDisc, "angle", 0, 360, 1)
                    .name("angle (yellow)")
                    .onChange(updateLuxo);
            }

            {
                // point light
                const light = new THREE.PointLight("white", 500);
                light.position.set(0, room.height, 0);
                scene.add(light);

                const helper = new THREE.PointLightHelper(light);
                scene.add(helper);
            }
            {
                // an ambient light
                const light = new THREE.AmbientLight("white", 0.3);
                scene.add(light);
            }

            const fov = 45;
            const aspect = 2; // the canvas default
            const near = 0.1;
            const far = 100;
            const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
            camera.position.set(0, room.height * 0.5, room.width * 1.4);

            const controls = new OrbitControls(camera, canvas);
            controls.target.set(0, room.height * 0.5, 0);
            controls.update();

            function resizeRendererToDisplaySize(renderer) {
                const canvas = renderer.domElement;
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                const needResize =
                    canvas.width !== width || canvas.height !== height;
                if (needResize) {
                    renderer.setSize(width, height, false);
                }
                return needResize;
            }

            function render() {
                if (resizeRendererToDisplaySize(renderer)) {
                    const canvas = renderer.domElement;
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                }

                renderer.render(scene, camera);

                requestAnimationFrame(render);
            }

            requestAnimationFrame(render);
        }

        main();
    </script>
</html>
